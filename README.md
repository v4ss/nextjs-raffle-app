# NextJS Raffle Project

## NewtJS Setup

Create the nextjs application :

```bash
yarn create next-app .
```

To install with `v12.1.5` :

```bash
npx create-next-app@12.1.5 .
```

To run the server :

```bash
yarn run dev
```

### Prettier

Add the prettier :

```bash
yarn add --dev prettier
```

And the files : `.prettierrc` and `.prettierignore`.

## Components

Create a new folder ad file `components/Header.jsx`

```jsx
export default function Header() {
    return <div>Hi from Header!</div>;
}
```

Import it in the `index` file or `page` file

```js
import Head from "next/head";
import Image from "next/image";
import styles from "../styles/Home.module.css";
import Header from "../components/Header"; // <-- Here

export default function Home() {
    return (
        <div className={styles.container}>
            <Head>
                <title>Smart Contract Lottery</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <Header />
            Hello !
        </div>
    );
}
```

And for the latest version :

```js
import Image from "next/image";
import styles from "./page.module.css";
import Header from "../components/Header";

export default function Home() {
    return (
        <div>
            <Header />
            Hello !
        </div>
    );
}
```

### Moralis and Manual Header

Add the packages :

```bash
yarn add moralis react-moralis
```

Add the Moralis Provider in the `_app.js` :

```js
import "../styles/globals.css";
import { MoralisProvider } from "react-moralis";

function MyApp({ Component, pageProps }) {
    return (
        <MoralisProvider initializeOnMount={false}>
            <Component {...pageProps} />
        </MoralisProvider>
    );
}

export default MyApp;
```

Modify the name of the component to `ManualHeader.jsx` and add this to manage the connexion

```js
import { useMoralis } from "react-moralis";
import { useEffect } from "react";

export default function ManualHeader() {
    const { enableWeb3, account, isWeb3Enabled, Moralis, deactivateWeb3, isWeb3EnableLoading } =
        useMoralis();

    // To check if we are connected on refresh, and if yes, connect automatically
    useEffect(() => {
        if (isWeb3Enabled) return;
        if (typeof window !== "undefined") {
            if (window.localStorage.getItem("connected")) enableWeb3();
        }
    }, []);

    // To check if the user disconnect his wallet, and if yes, delete the "connect" local storage storage item
    useEffect(() => {
        Moralis.onAccountChanged((account) => {
            console.log(`Account change to ${account}`);
            if (account == null) {
                window.localStorage.removeItem("connected");
                deactivateWeb3();
            }
        });
    }, [isWeb3Enabled]);
    return (
        <div>
            {account ? (
                <div>
                    Connected to {account.slice(0, 6)}...{account.slice(account.length - 4)}
                </div>
            ) : (
                <button
                    onClick={async () => {
                        await enableWeb3();
                        if (typeof window !== "undefined") {
                            window.localStorage.setItem("connected", "injected");
                        }
                    }}
                    disabled={isWeb3EnableLoading}
                >
                    Connect
                </button>
            )}
        </div>
    );
}
```

### Web3uikit and Header

Create the component `Header.jsx` and install the package :

```bash
yarn add web3uikit
```

```js Header.jsx
import { ConnectButton } from "web3uikit";

export default function Header() {
    return (
        <div>
            <h1>Decentralized Lottery</h1>
            <ConnectButton moralisAuth={false} />
        </div>
    );
}
```

Import it also in the `index.js` :

```js
import Head from "next/head";
import styles from "../styles/Home.module.css";
// import ManualHeader from "../components/ManualHeader";
import Header from "../components/Header";

export default function Home() {
    return (
        <div className={styles.container}>
            <Head>
                <title>Smart Contract Lottery</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            {/* <ManualHeader /> */}
            <Header />
            Hello !
        </div>
    );
}
```

### Calling functions : Lottery Entrance

Create a new components : `components/LotteryEntrance.jsx`

```js
import { useWeb3Contract } from "react-moralis";

export default function LotteryEntrance() {
    // const {runContractFunction: enterRaffle} = useWeb3Contract({
    //     abi: //,
    //     contractAddress: //,
    //     functionName: //,
    //     params: {},
    //     msgValue: //
    // })
}
```

#### Update Front end with a special deploy script

To store and update the abi, contract address, etc of the contract in the different network we deploy it, create a new folder `contants`.
Into, create two files

-   `abi.json`
-   `contractAddresses.json`

Return to the Raffle hardhat project and create a new deploy script to get automatically the ABI and contract address of the smart contract :
`99-update-front-end.js`

```js
const { ethers } = require("hardhat");
const fs = require("fs");

const FRONT_END_ADDRESSES_FILE = "../nextjs-raffle/constants/contractAddresses.json";
const FRONT_END_ABI_FILE = "../nextjs-raffle/constants/abi.json";

module.exports = async function () {
    if (process.env.UPDATE_FRONT_END) {
        console.log("Updating front end...");
        updateContractAddress();
        updateContractAbi();
    }
};

async function updateContractAddress() {
    const raffle = await ethers.getContract("Raffle");
    const chainId = network.config.chainId.toString();
    const currentAddresses = JSON.parse(fs.readFileSync(FRONT_END_ADDRESSES_FILE, "utf8"));
    if (chainId in currentAddresses) {
        if (!currentAddresses[chainId].includes(raffle.target)) {
            currentAddresses[chainId].push(raffle.target);
        }
    }
    {
        currentAddresses[chainId] = [raffle.target];
    }
    fs.writeFileSync(FRONT_END_ADDRESSES_FILE, JSON.stringify(currentAddresses));
}

async function updateContractAbi() {
    const raffle = await ethers.getContract("Raffle");
    fs.writeFileSync(FRONT_END_ABI_FILE, raffle.interface.formatJson());
}

module.exports.tags = ["all", "frontend"];
```

In the `.env` hardhat project file, add an `UPDATE_FRONT_END` variable equal to `true` :

```bash
UPDATE_FRONT_END=true
```

To load and update the front end constants, into the hardhat raffle project run :

```bash
yarn hardhat node
```

#### Return to the calling functions section

Now we have the abi and contract address. Create an `constants/index.js` file to export them in one command :

```js
const contractAddresses = require("./contractAddresses.json");
const abi = require("./abi.json");

module.exports = {
    contractAddresses,
    abi,
};
```

Now return to the `components/LotteryEntrance.jsx` component and import them :

```js
import { useWeb3Contract, useMoralis } from "react-moralis";
import { abi, contractAddresses } from "../constants";
import { useEffect, useState } from "react";
import { ethers } from "ethers";

export default function LotteryEntrance() {
    const { chainId: chainIdHex, isWeb3Enabled } = useMoralis(); // Return the Hex version of the chainId
    const chainId = parseInt(chainIdHex); // Get the decimal chainId
    const raffleAddress = chainId in contractAddresses ? contractAddresses[chainId][0] : null;
    const [entranceFee, setEntranceFee] = useState("0");

    const { runContractFunction: enterRaffle } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "enterRaffle",
        params: {},
        msgValue: entranceFee,
    });

    const { runContractFunction: getEntranceFee } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "getEntranceFee",
        params: {},
    });

    useEffect(() => {
        if (isWeb3Enabled) {
            async function updateUI() {
                const entranceFeeFromCall = (await getEntranceFee()).toString();
                setEntranceFee(entranceFeeFromCall);
            }
            updateUI();
        }
    }, [isWeb3Enabled]);

    return (
        <div>
            Hi from lottery entrance!
            {raffleAddress ? (
                <div>
                    <button
                        onClick={async function () {
                            await enterRaffle();
                        }}
                    >
                        Enter Raffle
                    </button>
                    Entrance Fee : {ethers.utils.formatEther(entranceFee)} ETH
                </div>
            ) : (
                <div>No Raffle Address Detected</div>
            )}
        </div>
    );
}
```

### Use Notification

Import `NotificationsProvider` in the `_app.js` and add it in the return :

```js
import "../styles/globals.css";
import { MoralisProvider } from "react-moralis";
import { NotificationProvider } from "web3uikit";

function MyApp({ Component, pageProps }) {
    return (
        <MoralisProvider initializeOnMount={false}>
            <NotificationProvider>
                <Component {...pageProps} />
            </NotificationProvider>
        </MoralisProvider>
    );
}

export default MyApp;
```

Then, import the hook of this, in the component `LotteryEntrance.jsx` and create the notification :

```js
import { useWeb3Contract, useMoralis } from "react-moralis";
import { abi, contractAddresses } from "../constants";
import { useEffect, useState } from "react";
import { ethers } from "ethers";
import { useNotification } from "web3uikit";

export default function LotteryEntrance() {
    const { chainId: chainIdHex, isWeb3Enabled } = useMoralis(); // Return the Hex version of the chainId
    const chainId = parseInt(chainIdHex); // Get the decimal chainId
    const raffleAddress = chainId in contractAddresses ? contractAddresses[chainId][0] : null;
    const [entranceFee, setEntranceFee] = useState("0");

    const dispatch = useNotification();

    const { runContractFunction: enterRaffle } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "enterRaffle",
        params: {},
        msgValue: entranceFee,
    });

    const { runContractFunction: getEntranceFee } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "getEntranceFee",
        params: {},
    });

    useEffect(() => {
        if (isWeb3Enabled) {
            async function updateUI() {
                const entranceFeeFromCall = (await getEntranceFee()).toString();
                setEntranceFee(entranceFeeFromCall);
            }
            updateUI();
        }
    }, [isWeb3Enabled]);

    const handleSuccess = async function (tx) {
        await tx.wait(1);
        handleNewNotification(tx);
    };

    const handleNewNotification = function () {
        dispatch({
            type: "info",
            message: "Transaction Complete!",
            title: "Transaction Notification",
            position: "topR",
            // icon: "bell",
        });
    };

    return (
        <div>
            Hi from lottery entrance!
            {raffleAddress ? (
                <div>
                    <button
                        onClick={async function () {
                            await enterRaffle({
                                onSuccess: handleSuccess,
                            });
                        }}
                    >
                        Enter Raffle
                    </button>
                    Entrance Fee : {ethers.utils.formatEther(entranceFee)} ETH
                </div>
            ) : (
                <div>No Raffle Address Detected</div>
            )}
        </div>
    );
}
```

## Reading & Displaying Contract Data

Add two useState variables for number of players and recent winner :

```js
import { useWeb3Contract, useMoralis } from "react-moralis";
import { abi, contractAddresses } from "../constants";
import { useEffect, useState } from "react";
import { ethers } from "ethers";
import { useNotification } from "web3uikit";

export default function LotteryEntrance() {
    const { chainId: chainIdHex, isWeb3Enabled } = useMoralis(); // Return the Hex version of the chainId
    const chainId = parseInt(chainIdHex); // Get the decimal chainId
    const raffleAddress = chainId in contractAddresses ? contractAddresses[chainId][0] : null;
    const [entranceFee, setEntranceFee] = useState("0");
    const [numPlayers, setNumPlayer] = useState("0"); // Here
    const [recentWinner, setRecentWinner] = useState("0");

    const dispatch = useNotification();

    const { runContractFunction: enterRaffle } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "enterRaffle",
        params: {},
        msgValue: entranceFee,
    });

    const { runContractFunction: getEntranceFee } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "getEntranceFee",
        params: {},
    });

    const { runContractFunction: getNumberOfPlayers } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "getNumberOfPlayers",
        params: {},
    });

    const { runContractFunction: getRecentWinner } = useWeb3Contract({
        abi: abi,
        contractAddress: raffleAddress,
        functionName: "getRecentWinner",
        params: {},
    });

    async function updateUI() {
        const entranceFeeFromCall = (await getEntranceFee()).toString();
        const numPlayersFromCall = (await getNumberOfPlayers()).toString();
        const recentWinnerFromCall = await getRecentWinner();
        setEntranceFee(entranceFeeFromCall);
        setNumPlayer(numPlayersFromCall);
        setRecentWinner(recentWinnerFromCall);
    }

    useEffect(() => {
        if (isWeb3Enabled) {
            updateUI();
        }
    }, [isWeb3Enabled]);

    const handleSuccess = async function (tx) {
        await tx.wait(1);
        handleNewNotification(tx);
        updateUI(); // Here
    };

    const handleNewNotification = function () {
        dispatch({
            type: "info",
            message: "Transaction Complete!",
            title: "Transaction Notification",
            position: "topR",
            // icon: "bell",
        });
    };

    return (
        <div>
            Hi from lottery entrance!
            {raffleAddress ? (
                <div>
                    <button
                        onClick={async function () {
                            await enterRaffle({
                                onSuccess: handleSuccess,
                            });
                        }}
                    >
                        Enter Raffle
                    </button>
                    Entrance Fee : {ethers.utils.formatEther(entranceFee)} ETH <br />
                    Number of players : {numPlayers} {/* Here */}
                    <br />
                    Recent Winner : {recentWinner}
                </div>
            ) : (
                <div>No Raffle Address Detected</div>
            )}
        </div>
    );
}
```

## Tailwind CSS

Install Tailwind in the project :

```bash
yarn add --dev tailwindcss postcss autoprefixer
```

Init tailwind :

```bash
yarn tailwindcss init -p
```

You have now two new files : `tailwind.config.js` and `postcss.config.js`. In `tailwind.config.js`, paste this :

```js
module.exports = {
    content: [".pages/**/*.{js,ts,jsx,tsx}", "./components/**/*.{js,ts,jsx,tsx}"],
    theme: {
        extend: {},
    },
    plugins: [],
};
```

Then go to `styles/globals.css` and paste this :

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

Install the `PostCSS Language Support` and `Tailwind CSS IntelliSense` extensions in VSCode.

## Introducing to Hosting your site

### Hosting with IPFS

First install, IPFS Desktop on their website : https://github.com/ipfs/ipfs-desktop/releases

In `next.config.js` add `output: "export",`. Like this :

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
    reactStrictMode: true,
    output: "export",
};

module.exports = nextConfig;
```

Then, run `yarn build`.
Now you have an `out/` folder and this is this folder we import in IPFS Files. Set the pin to Local Node, copy the CID and in a Browser go to `ipfs://YOUR_CID`

#### IPFS Using Fleek

Go to https://www.fleek.co

-   Sign up with Github
-   "Add new site"
-   Continuous deployment --> Connect with Github
